<!doctype html><html><head>
	<title>test de indexed database</title>
	<meta name='viewport' content='width=device-width,initial-scale=1'/>
	<meta charset='utf-8'/>
	<base target='_blank'>
	<link rel='stylesheet' type='text/css' href='C:\Users\deborah.powers\Desktop\html\utils\structure.css'/>
	<link rel='stylesheet' type='text/css' href='C:\Users\deborah.powers\Desktop\html\utils\debbyPlay.css'/>
	<link rel='stylesheet' type='text/css' href='C:\Users\deborah.powers\Desktop\html\utils\perso.css' media='screen'/>
	<script type='text/javascript' src='C:\Users\deborah.powers\Desktop\html\utils\text.js'></script>
	<script type='text/javascript' src='C:\Users\deborah.powers\Desktop\html\utils\debbyPlay.js'></script>
<style type='text/css'>
	div {
		display: grid;
		grid-template-columns: 2cm 1fr;
	}
	button { min-width: 3em; }
	a { display: block; }
</style></head><body>
	<h1>utiliser indexedDB avec ma pwa, afin de gérer les données de l'utilisateur</h1>
	<a href='https://developer.mozilla.org/en-US/docs/Web/API/indexedDB_API/Using_indexedDB'>infos de mozilla</a>
	<a href='https://www.tutorialspoint.com/html5/html5_indexedDB.htm'>tutorial point</a>
	<h2>entrez un nouveau livre</h2>
	<div>
		<span>code</span><input type='text' value='(( book.code ))'>
		<span>titre</span><input type='text' value='(( book.title ))'>
		<span>auteur</span><input type='text' value='(( book.autor ))'>
		<span>date</span><input type='text' value='(( book.date ))'>
		<span>prix</span><input type='text' value='(( book.price ))'>
	</div>
	<button onclick='addUpdateBook()'>ajouter</button>
	<table>
		<caption>livres en stoques</caption>
		<tr><th>auteur</th><th>titre</th><th>code</th><th>date</th><th>prix</th><th>éffacer</th></tr>
		<tr for='books'>
			<td>(( autor ))</td><td>(( title ))</td><td><button onclick='selBook("(( code ))")'>(( code ))</button></td><td>(( date ))</td><td>(( price ))</td><td><button onclick='delBook("(( code ))")'>X</button></td></tr>
	</table>
	<script type='text/javascript'>
document.body.init();
debbyPlay.book ={ code: "", title: "", price: "", date: "", autor: "" };
debbyPlay.books =[];
// vérifier si mon navigateur supporte indexedDB
window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction || {READ_WRITE: 'readwrite'};
window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
if (! window.indexedDB) console.log ('votre navigateur ne supporte pas indexedDB.');
else console.log ('votre navigateur supporte indexedDB !');
// le crud
const bookData =[
	{ code: 'xoxo', title: "l'histoire sans fin", price: 20, date: '1973', autor: 'michael ende' },
	{ code: 'coco', title: "le vieil homme et la mer", price: 15, date: '1947', autor: 'ernest hemingway' }
];
var database;
var request = window.indexedDB.open ('book_db', 3);
request.onerror = function (event){ console.log ('error: '); };
request.onsuccess = function (event){
	database = request.result;
	listBook();
};

request.onupgradeneeded = function (event){
	var database = event.target.result;
	// var objectStore = database.createObjectStore ('book_store', { autoIncrement: true });
	var objectStore = database.createObjectStore ('book_store', {keyPath: 'code'});
	// deux livres peuvent avoir le même auteur
	objectStore.createIndex ('autor', 'autor', { unique: false });
	objectStore.createIndex ('date', 'date', { unique: false });
	// chaque livre doit avoir un titre unique
	objectStore.createIndex ('title', 'title', { unique: true });
	for (var i in bookData) objectStore.add (bookData[i]);
	document.body.load();
}
function selBook (code){
	var transaction = database.transaction (['book_store']);
	var objectStore = transaction.objectStore ('book_store');
	var request = objectStore.get (code);
	request.onerror = function (event){ console.log ('impossible de récupérer les données'); };
	request.onsuccess = function (event){
		if (request.result){
			debbyPlay.book = request.result;
			document.body.load();
		}
		else console.log ('le livre de code', code, "n'est pas dans la base");
};}
function listBook(){
	debbyPlay.books =[];
	var objectStore = database.transaction ('book_store').objectStore ('book_store');
	objectStore.openCursor().onsuccess = function (event){
		var cursor = event.target.result;
		if (cursor){
			debbyPlay.books.push (cursor.value);
			cursor.continue();
		}
		else console.log ('tout est récupéré');
		document.body.load();
};}
function getBookData(){
	var inputs = document.getElementsByTagName ('input');
	debbyPlay.book.code = inputs[0].value;
	debbyPlay.book.title = inputs[1].value;
	debbyPlay.book.autor = inputs[2].value;
	debbyPlay.book.date = inputs[3].value;
	debbyPlay.book.price = inputs[4].value;
}
function addBook(){
	getBookData();
	var request = database.transaction (['book_store'], 'readwrite').objectStore ('book_store').add (debbyPlay.book);
	request.onsuccess = function (event){
		console.log ('le nouveau livre, '+ debbyPlay.book.title +' est enregistré'); }
	request.onerror = function (event){ console.log ('le nouveau livre, '+ debbyPlay.book.title +" n'a pas put être enregistré"); }
}
function updateBook(){
	getBookData();
	var request = database.transaction (['book_store'], 'readwrite').objectStore ('book_store').put (debbyPlay.book);
	request.onsuccess = function (event){
		console.log ('le nouveau livre, '+ debbyPlay.book.title +' est enregistré'); }
	request.onerror = function (event){ console.log ('le nouveau livre, '+ debbyPlay.book.title +" n'a pas put être enregistré"); }
}
function addUpdateBook(){
	getBookData();
	var transaction = database.transaction (['book_store']);
	var objectStore = transaction.objectStore ('book_store');
	var request = objectStore.get (debbyPlay.book.code);
	request.onerror = function (event){ console.log ('impossible de récupérer les données'); };
	request.onsuccess = function (event){
		if (request.result) updateBook();
		else addBook();
	};
}
function delBook (code){
	var request = database.transaction (['book_store'], 'readwrite').objectStore ('book_store').delete (code);
	request.onsuccess = function (event){ console.log ('le livre de code '+ code +' à été supprimé'); };
}
function addBook_simple(){
	var inputs = document.getElementsByTagName ('input');
	debbyPlay.book.code = inputs[0].value;
	debbyPlay.book.title = inputs[1].value;
	debbyPlay.book.autor = inputs[2].value;
	debbyPlay.book.date = inputs[3].value;
	debbyPlay.book.price = inputs[4].value;
	var request = database.transaction (['book_store'], 'readwrite').objectStore ('book_store').put (debbyPlay.book);
	request.onsuccess = function (event){
		console.log ('le nouveau livre, '+ debbyPlay.book.title +' est enregistré'); }
	request.onerror = function (event){ console.log ('le nouveau livre, '+ debbyPlay.book.title +" n'a pas put être enregistré"); }
}
</script></body></html>
